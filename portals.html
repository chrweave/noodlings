
<!DOCTYPE html>
<html xml:lang="en-us">
	<head>
		<title>
			Portal RPG
		</title>		
	</head>
	<body>
		<h1>Portal RPG</h1>
		<h2 id="location">Enter the portal</h2>
		<form id="initform" onSubmit="return parseArgs()" style="display:block";>
			Randomizing Key (text): <br/>
			<input id="rKey" type ="text"/><br/>				
			<button id="rButton">Generate it!</button>
		</form>
		<form id="transportform" onSubmit="return spellHop()" style="display:none">
			Spell (text): <br/>
			<input id="tKey" type ="text"/><br/>				
			<button id="rButton">Cast Hop Spell!</button>
		</form>
		<div id ="target">
		</div>
		<div id="realmMap">
		</div>
		<script src="./rc4Gen.js">
		</script> 
		<script src="./latinSquare.js">
		</script>
		<script src="wordMaker.js"> 
		</script>
		<script src="./squareLinkTable.js">
		</script>
		<script src="./squareHighlighter.js">
		</script>
		<script src="./squareReader.js">
		</script>
		<script type="text/javascript">
			var sixDice=new rc4Gen(512);
			var locs = [];
			var visited = [];
			var mapCells=[];
			var currentLocation;
			var rollCells=[];
			var xy = [];
			
			function checkWin(){
				var ret = true;
				var i;
				for(i=0;i<43;i++){
					ret=ret && visited[i]==1;
				}
				return ret;
			}
			
			function spellHop(){
				var s=locs[currentLocation];
				s+=document.getElementById("tKey").value;
				sixDice.initBuffer(s);
				var i;
				var k=0;
				var j;
				for(i=0;i<6;i++){
					j=sixDice.pump()%8;
					var q=i+1;
					var r=j+1;
					k+=j;
					rollCells[i].innerHTML="die"+q+" = "+r;
				}
				currentLocation=xy[currentLocation][k];
				visited[currentLocation]=1;
				document.getElementById("location").innerHTML="Welcome to "+locs[currentLocation]+"!";
				mapCells[currentLocation].style.background="Lime";
				if (checkWin()){
					document.getElementById("location").innerHTML+=" You have won!";
				}
				return false;
			}
			
			function cellSet(row, inText){
				var elem=row.insertCell();
				elem.style.borderWidth = "1px";
				elem.style.borderColor = "#000";
				elem.style.borderStyle = "solid";
				var text=document.createTextNode(inText);
				elem.appendChild(text);
				return elem;
			}
			
			function parseArgs(){
				var cubeDim=43; 
				var keyString = document.getElementById("rKey").value;
				var lat=new latinSquare(cubeDim,keyString);
				var targ=document.getElementById("target");
				xy=lat.latin();
				var wm=new wordMaker(keyString,0);
				var i;
				for(i=0;i<43;i++){
					visited[i]=0;
				}
				locs=wm.makeWords(visited);
				var t=document.createElement("TABLE");
				var tbody=t.createTBody();
				var tr=tbody.insertRow();
				var k=0;
				mapCells[k]=cellSet(tr,locs[k]);
				mapCells[0].colspan=6;
				mapCells[0].style.background="DeepPink";
				k++;
				var j;
				for(i=0;i<7;i++){
					tr=tbody.insertRow();
					for(j=0;j<6;j++){
						mapCells[k]=cellSet(tr,locs[k]);
						k++;
					}
				}
				document.getElementById("realmMap").appendChild(t);
				currentLocation=0
				document.getElementById("location").innerHTML="Welcome to "+locs[currentLocation]+"!";
				document.getElementById("initform").style.display="none";
				document.getElementById("transportform").style.display="block";
				t=document.createElement("TABLE");
				tbody=t.createTBody();				
				k=0;
				for(i=0;i<2;i++){
					tr=tbody.insertRow();
					for(j=0;j<3;j++){
						var q=k+1;
						rollCells[k]=cellSet(tr,"die"+q);
						k++;
					}
				}
				t.style.padding = "50px 10px 20px 30px";
				document.getElementById("target").appendChild(t);
				return false;
			}
		</script>
	</body>
</html>