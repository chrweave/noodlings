
<!DOCTYPE html>
<html xml:lang="en-us">
	<head>		
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>
			Portal RPG
		</title>		
	</head>
	<body>
		<h1>Portal RPG</h1>
		<h2 id="location">Enter the portal</h2>
		<form id="initform" onSubmit="return parseArgs()" style="display:block">
			Randomizing Key (text): <br/>
			<input id="rKey" type ="text"/><br/>				
			<button id="rButton">Generate it!</button>
		</form>
		<form id="transportform" onSubmit="return spellHop()" style="display:none">
			Spell (text): <br/>
			<input id="tKey" type ="text"/><br/>				
			<button id="rButton">Cast Hop Spell!</button>
		</form>
		<div id ="target" style="padding 20px; font-size:2em;">Dice roll here.
		</div>
		<div id="realmMap">
		</div>
		<script src="./rc4Gen.js">
		</script> 
		<script src="./latinSquare.js">
		</script>
		<script src="wordMaker.js"> 
		</script>
		<script src="./squareLinkTable.js">
		</script>
		<script src="./squareHighlighter.js">
		</script>
		<script src="./squareReader.js">
		</script>
		<script type="text/javascript">
			var sixDice=new rc4Gen(512);
			var locs = [];
			var visited = [];
			var mapCells=[];
			var currentLocation;
			var rollCells=[];
			var xy = [];
			
			function checkWin(){
				var ret = true;
				var i;
				for(i=0;i<43;i++){
					ret=ret && visited[i]==1;
				}
				return ret;
			}
			
			function spellHop(){
				var s=locs[currentLocation];
				var q = document.getElementById("tKey").value;
				s+=q;
				q='';
				sixDice.initBuffer(s);
				var i;
				var k=0;
				var j;
				var tx="";
				for(i=0;i<6;i++){
					j=sixDice.pump()%8;
					var q=i+1;
					var r=j+1;
					k+=j;
					tx += r;
					if(i<5){
						tx += " + ";
					} else {
						tx += " = ";
					}
				}
				i=k+6;
				tx += i;
				document.getElementById("target").innerHTML=tx;
				currentLocation=xy[currentLocation][k];
				visited[currentLocation]=1;
				document.getElementById("location").innerHTML="Welcome to "+locs[currentLocation]+"!";
				mapCells[currentLocation].style.background="Lime";
				if (checkWin()){
					document.getElementById("location").innerHTML+=" You have won!";
				}
				return false;
			}
			
			function wordSet(elem,inText){
				elem.style.borderWidth = "1px";
				elem.style.borderColor = "#000";
				elem.style.borderStyle = "solid";
				elem.style.display="inline-block";
				elem.style.padding="5px";
				elem.style.margin="2px";
				var text=document.createTextNode(inText);
				elem.appendChild(text);
				elem.addEventListener('click', e => {
					document.getElementById("tKey").value=elem.innerHTML;
					elem.style.background="DodgerBlue";
				});
			}
			
			function parseArgs(){
				var cubeDim=43; 
				var keyString = document.getElementById("rKey").value;
				var lat=new latinSquare(cubeDim,keyString);
				var targ=document.getElementById("target");
				xy=lat.latin();
				var lgs=[1,1,1,2];
				var wm=new wordMaker(keyString,1,lgs);
				var i;
				for(i=0;i<43;i++){
					visited[i]=0;
				}
				locs=wm.makeWords(visited);
				for (i=0;i<43;i++){
					mapCells[i]=document.createElement("DIV");
					wordSet(mapCells[i],locs[i]);
					document.getElementById("realmMap").appendChild(mapCells[i]);
				}
				mapCells[0].style.background="DeepPink";
				
				
				currentLocation=0
				document.getElementById("location").innerHTML="Welcome to "+locs[currentLocation]+"!";
				document.getElementById("initform").style.display="none";
				document.getElementById("transportform").style.display="block";
				t=document.createElement("TABLE");
				tbody=t.createTBody();
				return false;
			}
		</script>
	</body>
</html>