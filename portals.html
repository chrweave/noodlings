<!DOCTYPE html>
<html xml:lang="en-us">
	<head>		
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>
			Portal RPG
		</title>		
	</head>
	<body>
		<h1 id="realmheader">Choose your realm!</h1>
		<h2 id="location">Enter the portal</h2>
		<form id="initform" onSubmit="return parseArgs()" style="display:block">
			Choose your Realm (text): <br/>
			<input id="rKey" type ="text" oninput="tweakRealmButton()"/><br/>				
			<button id="rButton">Enter!</button>
		</form>
		<form id="transportform" onSubmit="return spellHop()" style="display:none">
			Hop Spell (text): <br/>
			<input id="tKey" type ="text"/><br/>				
			<button >Cast Hop Spell!</button>
		</form>
		<form id="exit" onSubmit="return validateKey()" style="display:none">
			Exit Key: <br/>
			<input id="exitKey" type ="text"/><br/>	
			<button >Turn Exit Key!</button>
		</form>
		<div id="McGuffinButtons">
		</div>
		<div id="realmMap">
		</div>
		<script src="./rc4Gen.js">
		</script> 
		<script src="./latinSquare.js">
		</script>
		<script src="wordMaker.js"> 
		</script>
		<script type="text/javascript">
			class realmLocation {
				constructor(inName,inMcGuffin){
					this.name=inName;
					this.mcGuffin=inMcGuffin;
					this.visited=0;
					this.hint="";
				}
			}
			var hopDice=new rc4Gen(512);
			var pumpdie=new rc4Gen(560);
			var locs = [];
			var mapCells=[];
			var currentLocation;
			var rollCells=[];
			var xy = [];
			var nameMaker;
			var winString="";
			
			function calculateWinString(x){
				var ga= new rc4Gen(43);
				ga.initBuffer(x);
				var i;
				for(i=0;i<43;i++){
					var k=locs[ga.buffer[i]].mcGuffin;
					if(k!="nm"){
						winString+=k;
					}
				}
			}
			
			function validateKey(){
				var q=document.getElementById("exitKey");
				var r=document.getElementById("location");
				if(q.value == winString){
					r.innerHTML+=" You have won!";
				} else {
					r.innerHTML+=" Try a different order!";
				}
				q.value="";
				return false;
			}
			function tweakRealmButton(){
				document.getElementById("rButton").innerHTML="Enter "+document.getElementById("rKey").value+"!";
				return false;
			}
			
			function checkWin(){
				var ret = true;
				var i;
				for(i=0;i<43;i++){
					ret=ret && locs[i].visited==1;
				}
				return ret;
			}
			
			function checkLocationForToken(x){
				if (x.visited==0){ 
					if(x.mcGuffin!="nm"){
						var b=document.createElement("DIV");
						b.innerHTML=x.mcGuffin;
						b.style.background="DodgerBlue";
						b.style.borderWidth = "1px";
						b.style.borderColor = "#f00";
						b.style.borderStyle = "solid";
						b.style.display="inline-block";
						b.style.padding="5px";
						b.style.margin="2px";
						b.id=x.mcGuffin;
						b.addEventListener('click', e => {
							document.getElementById("exitKey").value+=x.mcGuffin;
						});
						document.getElementById("McGuffinButtons").appendChild(b);
					}
					x.visited=1;
				}
			}
			
			function spellHop(){
				var s=locs[currentLocation];
				var q = document.getElementById("tKey").value;
				s+=q;
				q='';
				hopDice.initBuffer(s);
				var i;
				var k=0;
				var j;
				for(i=0;i<6;i++){
					j=hopDice.pump()%8;
					k+=j;
				}
				currentLocation=xy[currentLocation][k];
				
				checkLocationForToken(locs[currentLocation]);
				document.getElementById("location").innerHTML="Welcome to "+locs[currentLocation].name+"!";
				mapCells[currentLocation].style.background="Lime";
				//if (checkWin()){
				//	document.getElementById("location").innerHTML+=" You have won!";
				//}
				//adding winnig by mcguffin key
				return false;
			}
			
			function getNumfromID(e){
				return parseInt(e.id.replace(/location/,''));
			}
				
			
			function wordSet(elem,inText,index){
				elem.style.borderWidth = "1px";
				elem.style.borderColor = "#000";
				elem.style.borderStyle = "solid";
				elem.style.display="inline-block";
				elem.style.padding="5px";
				elem.style.margin="2px";
				elem.id="location"+index;
				var text=document.createTextNode(inText);
				elem.appendChild(text);
				elem.addEventListener('click', e => {
					var n=getNumfromID(elem);
					if(n==n&&locs[n].visited >0){
						document.getElementById("tKey").value=elem.innerHTML;
						elem.style.background="DodgerBlue";
					}
				});
			}
			
			function parseArgs(){
				var cubeDim=43; 
				var keyString = document.getElementById("rKey").value;
				var lat=new latinSquare(cubeDim,keyString);
				var targ=document.getElementById("target");
				xy=lat.latin();
				var lgs=[1,1,1,2];
				var ns=[1];
				var wm=new wordMaker(keyString,lgs,"");
				var nameMaker=new wordMaker(keyString.split('').reverse().join(),ns,"");
				var i;
				var caps =[];
				for(i=0;i<43;i++){
					caps[i]=0;
				}
				pumpdie.initBuffer(keyString);
				var locsa=wm.makeWords(caps);
				for (i=0;i<43;i++){
					mapCells[i]=document.createElement("DIV");
					wordSet(mapCells[i],locsa[i],i);
					document.getElementById("realmMap").appendChild(mapCells[i]);					
					locs[i]=new realmLocation(locsa[i],pumpdie.pump()%7==0?nameMaker.makeSingleWord(0):"nm");
				}
				calculateWinString(locs[0].name);
				mapCells[0].style.background="DeepPink";
				checkLocationForToken(locs[0]);
				
				
				currentLocation=0
				document.getElementById("location").innerHTML="Welcome to "+locs[currentLocation].name+"!";
				document.getElementById("initform").style.display="none";
				document.getElementById("transportform").style.display="block";
				document.getElementById("exit").style.display="block";
				document.getElementById("realmheader").innerHTML="Jurney through the realm of "+keyString+"."+winString;
				t=document.createElement("TABLE");
				tbody=t.createTBody();
				return false;
			}
		</script>
	</body>
</html>
